<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/header :: head}"></head>
<body>
<div th:replace="~{fragments/header :: nav}"></div>

<div class="container my-5">
    <div class="row">
        <div class="col-md-3">
            <div class="list-group">
                <a th:href="@{/professional/dashboard}" class="list-group-item list-group-item-action">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a th:href="@{/professional/profile}" class="list-group-item list-group-item-action">
                    <i class="fas fa-user"></i> My Profile
                </a>
                <a th:href="@{/professional/profile/edit}" class="list-group-item list-group-item-action">
                    <i class="fas fa-edit"></i> Edit Profile
                </a>
                <a th:href="@{/professional/availability}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-calendar"></i> Availability
                </a>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-calendar-alt"></i> Manage Your Availability</h4>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addAvailabilityModal">
                        <i class="fas fa-plus"></i> Add Availability
                    </button>
                </div>
                <div class="card-body">
                    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" th:text="${message}">
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" th:text="${error}">
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    
                    <!-- Validation Errors -->
                    <div th:if="${validationErrors}" class="alert alert-warning alert-dismissible fade show">
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        <ul class="mb-0">
                            <li th:each="error : ${validationErrors.allErrors}" th:text="${error.defaultMessage}"></li>
                        </ul>
                    </div>
                    
                    <!-- Date Navigation -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <form th:action="@{/professional/availability}" method="get" class="d-flex">
                                <input type="date" name="date" class="form-control me-2" 
                                       th:value="${selectedDate}" required>
                                <button type="submit" class="btn btn-outline-primary">View Date</button>
                            </form>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bulkAddModal">
                                <i class="fas fa-calendar-plus"></i> Bulk Add
                            </button>
                        </div>
                    </div>
                    
                    <!-- Availability for Selected Date -->
                    <div th:if="${selectedDate}">
                        <h5>Availability for <span th:text="${#temporals.format(selectedDate, 'MMMM dd, yyyy')}"></span></h5>
                        
                        <div th:if="${!availabilities.empty}">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="slot : ${availabilities}">
                                            <td>
                                                <span th:text="${#temporals.format(slot.startTime, 'hh:mm a')}"></span>
                                                <span> - </span>
                                                <span th:text="${#temporals.format(slot.endTime, 'hh:mm a')}"></span>
                                            </td>
                                            <td>
                                                <span th:if="${!slot.booked}" class="badge bg-success">Available</span>
                                                <span th:if="${slot.booked}" class="badge bg-secondary">Booked</span>
                                            </td>
                                            <td>
                                                <form th:if="${!slot.booked}" 
                                                      th:action="@{/professional/availability/delete/{id}(id=${slot.id})}" 
                                                      method="post" class="d-inline">
                                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                                    <input type="hidden" name="date" th:value="${selectedDate}"/>
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                            onclick="return confirm('Are you sure you want to delete this availability slot?')">
                                                        <i class="fas fa-trash"></i> Remove
                                                    </button>
                                                </form>
                                                <span th:if="${slot.booked}">-</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div th:if="${availabilities.empty}">
                            <div class="text-center py-3">
                                <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                                <p class="text-muted">No availability slots set for this date.</p>
                                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAvailabilityModal">
                                    <i class="fas fa-plus"></i> Add First Slot
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- All Future Availability -->
                    <div class="mt-4">
                        <h5>All Future Availability</h5>
                        <div th:if="${hasFutureAvailabilities}">
                            <div class="list-group">
                                <div th:each="slot : ${futureAvailabilities}" class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong th:text="${#temporals.format(slot.date, 'MMM dd, yyyy')}"></strong>
                                        <span class="ms-2" th:text="${#temporals.format(slot.startTime, 'hh:mm a')} + ' - ' + ${#temporals.format(slot.endTime, 'hh:mm a')}"></span>
                                    </div>
                                    <div>
                                        <span th:if="${!slot.booked}" class="badge bg-success me-2">Available</span>
                                        <span th:if="${slot.booked}" class="badge bg-secondary me-2">Booked</span>
                                        <form th:if="${!slot.booked}" 
                                              th:action="@{/professional/availability/delete/{id}(id=${slot.id})}" 
                                              method="post" class="d-inline">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                    onclick="return confirm('Are you sure you want to delete this availability slot?')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${!hasFutureAvailabilities}">
                            <p class="text-muted">No future availability slots set.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Single Availability Modal -->
<div class="modal fade" id="addAvailabilityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="singleAvailabilityForm" th:action="@{/professional/availability/add}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="modal-header">
                    <h5 class="modal-title">Add Availability Slot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="date" name="date" 
                               th:value="${selectedDate}" required>
                        <div class="invalid-feedback" id="dateError"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="startTime" name="startTime" required>
                            <div class="invalid-feedback" id="startTimeError"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endTime" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="endTime" name="endTime" required>
                            <div class="invalid-feedback" id="endTimeError"></div>
                        </div>
                    </div>
                    
                    <div class="alert alert-danger d-none" id="singleFormError"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Slot</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Add Modal -->
<div class="modal fade" id="bulkAddModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="bulkAvailabilityForm" th:action="@{/professional/availability/bulk-add}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <!-- Hidden field to store the generated dates array -->
                <input type="hidden" id="generatedDates" name="dates"/>
                
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Add Availability</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Date Range</label>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" required>
                                <div class="invalid-feedback" id="startDateError"></div>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label for="endDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" required>
                                <div class="invalid-feedback" id="endDateError"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bulkStartTime" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="bulkStartTime" name="bulkStartTime" required>
                            <div class="invalid-feedback" id="bulkStartTimeError"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bulkEndTime" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="bulkEndTime" name="bulkEndTime" required>
                            <div class="invalid-feedback" id="bulkEndTimeError"></div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="weeklyRecurrence" name="weeklyRecurrence">
                        <label class="form-check-label" for="weeklyRecurrence">
                            Repeat weekly
                        </label>
                    </div>
                    
                    <div id="weeklyOptions" class="mb-3" style="display: none;">
                        <label for="recurrenceWeeks" class="form-label">Number of weeks to repeat:</label>
                        <select class="form-control" id="recurrenceWeeks" name="recurrenceWeeks">
                            <option value="1">1 week</option>
                            <option value="2">2 weeks</option>
                            <option value="3">3 weeks</option>
                            <option value="4">4 weeks</option>
                            <option value="8">8 weeks</option>
                            <option value="12">12 weeks</option>
                        </select>
                    </div>
                    
                    <!-- Preview Section -->
                    <div id="datePreview" class="mt-3" style="display: none;">
                        <h6>Dates to be created:</h6>
                        <div id="previewList" class="small text-muted" style="max-height: 150px; overflow-y: auto;"></div>
                        <div id="previewCount" class="small text-info mt-2"></div>
                    </div>
                    
                    <div class="alert alert-danger d-none" id="bulkFormError"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Slots</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{fragments/header :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Phase 4: JavaScript Implementation
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    
    // Set min date to today for all date inputs
    document.querySelectorAll('input[type="date"]').forEach(input => {
        if (!input.min) {
            input.min = today;
        }
    });
    
    // Initialize form handlers
    initializeSingleAvailabilityForm();
    initializeBulkAvailabilityForm();
});

// Single Availability Form Validation
function initializeSingleAvailabilityForm() {
    const form = document.getElementById('singleAvailabilityForm');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    const dateInput = document.getElementById('date');
    
    // Real-time validation
    endTimeInput.addEventListener('change', function() {
        validateSingleTimeRange();
    });
    
    startTimeInput.addEventListener('change', function() {
        validateSingleTimeRange();
    });
    
    dateInput.addEventListener('change', function() {
        validateSingleDate();
    });
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        if (!validateSingleForm()) {
            e.preventDefault();
        }
    });
}

// Bulk Availability Form Validation
function initializeBulkAvailabilityForm() {
    const form = document.getElementById('bulkAvailabilityForm');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const bulkStartTimeInput = document.getElementById('bulkStartTime');
    const bulkEndTimeInput = document.getElementById('bulkEndTime');
    const weeklyRecurrenceCheckbox = document.getElementById('weeklyRecurrence');
    const weeklyOptions = document.getElementById('weeklyOptions');
    
    // Show/hide weekly options
    weeklyRecurrenceCheckbox.addEventListener('change', function() {
        if (this.checked) {
            weeklyOptions.style.display = 'block';
        } else {
            weeklyOptions.style.display = 'none';
        }
        updateDatePreview();
    });
    
    // Real-time validation and preview
    [startDateInput, endDateInput, bulkStartTimeInput, bulkEndTimeInput].forEach(input => {
        input.addEventListener('change', function() {
            validateBulkForm();
            updateDatePreview();
        });
    });
    
    document.getElementById('recurrenceWeeks').addEventListener('change', function() {
        updateDatePreview();
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        if (!validateBulkForm()) {
            e.preventDefault();
            return;
        }
        
        // Generate and set the dates array
        const dates = generateBulkDates();
        if (dates.length === 0) {
            showBulkError('No valid dates could be generated');
            e.preventDefault();
            return;
        }
        
        // Set the generated dates in the hidden field
        document.getElementById('generatedDates').value = dates.join(',');
    });
}

// Validation Functions
function validateSingleTimeRange() {
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const errorElement = document.getElementById('endTimeError');
    const endTimeInput = document.getElementById('endTime');
    
    if (startTime && endTime) {
        if (startTime >= endTime) {
            showFieldError(endTimeInput, errorElement, 'End time must be after start time');
            return false;
        } else {
            hideFieldError(endTimeInput, errorElement);
            return true;
        }
    }
    return true;
}

function validateSingleDate() {
    const dateInput = document.getElementById('date');
    const errorElement = document.getElementById('dateError');
    const selectedDate = new Date(dateInput.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
        showFieldError(dateInput, errorElement, 'Date cannot be in the past');
        return false;
    } else {
        hideFieldError(dateInput, errorElement);
        return true;
    }
}

function validateSingleForm() {
    const isTimeValid = validateSingleTimeRange();
    const isDateValid = validateSingleDate();
    
    return isTimeValid && isDateValid;
}

function validateBulkForm() {
    let isValid = true;
    
    // Validate date range
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const startDateError = document.getElementById('startDateError');
    const endDateError = document.getElementById('endDateError');
    
    if (startDate && endDate) {
        if (new Date(startDate) > new Date(endDate)) {
            showFieldError(endDateInput, endDateError, 'End date must be after start date');
            isValid = false;
        } else {
            hideFieldError(endDateInput, endDateError);
        }
        
        // Check if start date is not in the past
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (new Date(startDate) < today) {
            showFieldError(startDateInput, startDateError, 'Start date cannot be in the past');
            isValid = false;
        } else {
            hideFieldError(startDateInput, startDateError);
        }
    }
    
    // Validate time range
    const bulkStartTime = document.getElementById('bulkStartTime').value;
    const bulkEndTime = document.getElementById('bulkEndTime').value;
    const bulkStartTimeInput = document.getElementById('bulkStartTime');
    const bulkEndTimeInput = document.getElementById('bulkEndTime');
    const bulkStartTimeError = document.getElementById('bulkStartTimeError');
    const bulkEndTimeError = document.getElementById('bulkEndTimeError');
    
    if (bulkStartTime && bulkEndTime) {
        if (bulkStartTime >= bulkEndTime) {
            showFieldError(bulkEndTimeInput, bulkEndTimeError, 'End time must be after start time');
            isValid = false;
        } else {
            hideFieldError(bulkEndTimeInput, bulkEndTimeError);
        }
    }
    
    if (!isValid) {
        hideBulkError();
    }
    
    return isValid;
}

// Date Generation Functions
function generateDateRange(startDate, endDate) {
    const dates = [];
    const currentDate = new Date(startDate);
    const finalDate = new Date(endDate);
    
    while (currentDate <= finalDate) {
        dates.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return dates;
}

function generateBulkDates() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const weeklyRecurrence = document.getElementById('weeklyRecurrence').checked;
    const recurrenceWeeks = parseInt(document.getElementById('recurrenceWeeks').value) || 1;
    
    if (!startDate || !endDate) {
        return [];
    }
    
    let dates = generateDateRange(startDate, endDate);
    
    if (weeklyRecurrence && recurrenceWeeks > 1) {
        const additionalDates = [];
        const baseDates = [...dates];
        
        for (let week = 1; week < recurrenceWeeks; week++) {
            baseDates.forEach(date => {
                const newDate = new Date(date);
                newDate.setDate(newDate.getDate() + (week * 7));
                additionalDates.push(newDate);
            });
        }
        
        dates = dates.concat(additionalDates);
    }
    
    // Convert to YYYY-MM-DD format and sort
    return dates
        .map(date => date.toISOString().split('T')[0])
        .sort();
}

// Preview Functions
function updateDatePreview() {
    const dates = generateBulkDates();
    const previewElement = document.getElementById('datePreview');
    const previewList = document.getElementById('previewList');
    const previewCount = document.getElementById('previewCount');
    
    if (dates.length > 0) {
        previewElement.style.display = 'block';
        previewList.innerHTML = dates.map(date => {
            const dateObj = new Date(date + 'T00:00:00');
            return dateObj.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }).join('<br>');
        previewCount.textContent = `Total: ${dates.length} dates`;
    } else {
        previewElement.style.display = 'none';
    }
}

// Error Display Functions
function showFieldError(input, errorElement, message) {
    input.classList.add('is-invalid');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

function hideFieldError(input, errorElement) {
    input.classList.remove('is-invalid');
    errorElement.textContent = '';
    errorElement.style.display = 'none';
}

function showSingleError(message) {
    const errorElement = document.getElementById('singleFormError');
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
}

function hideSingleError() {
    const errorElement = document.getElementById('singleFormError');
    errorElement.classList.add('d-none');
}

function showBulkError(message) {
    const errorElement = document.getElementById('bulkFormError');
    errorElement.textContent = message;
    errorElement.classList.remove('d-none');
}

function hideBulkError() {
    const errorElement = document.getElementById('bulkFormError');
    errorElement.classList.add('d-none');
}

// Reset forms when modals are hidden
document.getElementById('addAvailabilityModal').addEventListener('hidden.bs.modal', function() {
    const form = document.getElementById('singleAvailabilityForm');
    form.reset();
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    form.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');
    hideSingleError();
});

document.getElementById('bulkAddModal').addEventListener('hidden.bs.modal', function() {
    const form = document.getElementById('bulkAvailabilityForm');
    form.reset();
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    form.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');
    document.getElementById('weeklyOptions').style.display = 'none';
    document.getElementById('datePreview').style.display = 'none';
    hideBulkError();
});
</script>
</body>
</html>